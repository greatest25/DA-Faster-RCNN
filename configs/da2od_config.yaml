# DA2OD Configuration for Cityscapes Domain Adaptation
# Base on Faster R-CNN R50 + FPN

# Inherit base Faster R-CNN config
_BASE_: "/mnt/lyh/DA-FasterCNN/detectron2-main/configs/COCO-Detection/faster_rcnn_R_50_FPN_1x.yaml"

# Model settings
MODEL:
  ROI_HEADS:
    NUM_CLASSES: 8  # Cityscapes classes: car, person, rider, truck, bus, train, motorcycle, bicycle

# DA2OD specific settings
DA:
  # Alignment module
  ENABLE_ALIGNER: True
  ENABLE_IMAGE_D: True
  ENABLE_INSTANCE_D: True
  ENABLE_CONSISTENCY: True
  
  # Loss weights
  LOSS_WEIGHT_IMAGE: 0.1
  LOSS_WEIGHT_INSTANCE: 0.1
  LOSS_WEIGHT_CONSISTENCY: 0.1
  
  # Pseudo labeling
  PSEUDO_LABEL:
    SCORE_THRESH: 0.7
    BOX_NMS: 0.7
    MAX_PER_IMAGE: 100
    USE_BOX_JITTER: False

# EMA (Exponential Moving Average) for Mean Teacher
EMA:
  ENABLED: True
  ALPHA: 0.999  # EMA decay coefficient
  LOAD_FROM_EMA_ON_START: False

# Distillation settings (optional, disable if not using teacher-student)
DA:
  DISTILL:
    ENABLED: False
    HARD_ROIH_CLS_ENABLED: False
    HARD_OBJ_ENABLED: False
    ROIH_CLS_ENABLED: True
    OBJ_ENABLED: True
    RPN_REG_ENABLED: False
    ROIH_REG_ENABLED: False
    CLS_TEMPERATURE: 1.0
    OBJ_TEMPERATURE: 1.0

# Data loader settings
DATALOADER:
  NUM_WORKERS: 2
  USE_DIFF_BS_SIZE: True
  SUP_PERCENT: 1.0
  FILTER_EMPTY_ANNOTATIONS: False

# Solver settings
SOLVER:
  IMS_PER_BATCH: 4
  BASE_LR: 0.0005
  WARMUP_FACTOR: 0.01
  WARMUP_ITERS: 1000
  MAX_ITER: 5000
  CHECKPOINT_PERIOD: 500

# Input settings
INPUT:
  MIN_SIZE_TRAIN: (600,)
  MIN_SIZE_TEST: 0

# Output directory
OUTPUT_DIR: "./output/da2od_baseline/"

# Datasets (will be overridden in script)
DATASETS:
  TRAIN: ("city_trainS",)
  TEST: ("city_testT",)

# Test settings
TEST:
  EVAL_PERIOD: 500
